// Generated by CoffeeScript 1.6.3
(function() {
  var $current_opt, local_source, shift, slot_id, slot_label;

  shift = false;

  slot_id = null;

  slot_label = null;

  $current_opt = null;

  local_source = {
    color: '#3a87ad'
  };

  $(document).bind('keyup keydown', function(e) {
    return shift = e.shiftKey;
  });

  $(document).ready(function() {
    var add, calendar, get_remaining, get_slot, set_remaining, set_slot;
    window._cal = calendar = $(".calendar").fullCalendar({
      header: {
        left: "",
        right: "prev,next today",
        center: "title"
      },
      firstDay: 1,
      selectable: true,
      selectHelper: true,
      select: function(start, end, allDay) {
        var day, _results;
        start = moment(start);
        end = moment(end);
        day = moment(start);
        _results = [];
        while (day.diff(end, 'days') < 1) {
          add(day);
          _results.push(day.add('days', 1));
        }
        return _results;
      },
      eventClick: function(event, jsEvent, view) {
        var remaining;
        window.e = event;
        remaining = get_remaining();
        if (event.className.indexOf('full') > -1) {
          event.className = ['am'];
          event.color = '#88bcd6';
          event.title += ' (Matin)';
          set_remaining(remaining + .5);
        } else if (event.className.indexOf('am') > -1) {
          event.className = ['pm'];
          event.color = '#6bb3d6';
          event.title = event.title.replace('Matin', 'Après-midi');
        } else if (event.className.indexOf('pm') > -1 && remaining > .5) {
          set_remaining(remaining - .5);
          event.className = ['full'];
          event.color = '#3a87ad';
          event.title = event.title.replace(' (Après-midi)', '');
        } else if (event.className.indexOf('pm') > -1) {
          event.className = ['am'];
          event.color = '#88bcd6';
          event.title = event.title.replace('Après-midi', 'Matin');
        }
        return calendar.fullCalendar('renderEvent', event);
      },
      editable: true,
      eventSources: [
        {
          url: 'http://www.google.com/calendar/feeds/french__fr@holiday.calendar.google.com/public/basic',
          color: '#ff724d',
          className: 'holiday',
          editable: false
        }, {
          events: function(start, end, callback) {
            return $.ajax({
              url: '/events/from/' + $.fullCalendar.formatDate(start, 'u') + '/to/' + $.fullCalendar.formatDate(end, 'u'),
              dataType: 'json',
              success: function(json) {
                return callback(json.events);
              }
            });
          },
          color: '#ffce4d',
          className: 'server',
          editable: false
        }
      ]
    });
    add = function(day_) {
      var cls, label, realEvent, remaining, _ref;
      realEvent = day_.diff(moment(), 'days') > -1 && ((_ref = day_.day()) !== 0 && _ref !== 6) && calendar.fullCalendar('clientEvents', (function(e) {
        return day_.diff(moment(e.start), 'days', true) === 0;
      })).length === 0;
      if (!realEvent && !shift) {
        calendar.fullCalendar("unselect");
        return;
      }
      if ($current_opt === null) {
        return;
      }
      remaining = get_remaining() - 1;
      if (remaining < -.5) {
        return;
      }
      cls = ['full'];
      label = slot_label;
      if (remaining === -.5) {
        label += ' (Matin)';
        cls = ['am'];
        remaining = 0;
      }
      set_remaining(remaining);
      calendar.fullCalendar("renderEvent", {
        title: label,
        start: new Date(day_.toDate()),
        allDay: true,
        className: cls
      }, true);
      return calendar.fullCalendar("unselect");
    };
    $('.calendar .fc-header-left').append($('<span>', {
      "class": 'fc-button fc-state-default fc-corner-left fc-corner-right'
    }).text('Save').hover((function() {
      return $(this).addClass('fc-state-hover');
    }), (function() {
      return $(this).removeClass('fc-state-hover fc-state-down');
    })).mousedown((function() {
      return $(this).addClass('fc-state-down');
    })).mouseup((function() {
      return $(this).removeClass('fc-state-down');
    }))).click(function() {
      var data, event, events, type, types, _i, _j, _len, _len1;
      events = calendar.fullCalendar('clientEvents', (function(e) {
        var _ref;
        return (_ref = e.className[0]) === 'full' || _ref === 'am' || _ref === 'pm';
      }));
      data = [];
      for (_i = 0, _len = events.length; _i < _len; _i++) {
        event = events[_i];
        if (event.className[0] === 'full') {
          types = ['am', 'pm'];
        } else {
          types = [event.className[0]];
        }
        for (_j = 0, _len1 = types.length; _j < _len1; _j++) {
          type = types[_j];
          data.push({
            day: $.fullCalendar.formatDate(event.start, 'u'),
            type: type,
            slot: get_slot(event.title.split('(')[0].trim())
          });
        }
      }
      if (data.length) {
        $.ajax({
          url: '/events/save',
          data: {
            events: JSON.stringify(data)
          },
          type: 'POST',
          success: function() {
            return location.reload();
          }
        });
      }
      return false;
    });
    get_remaining = function() {
      return parseFloat($current_opt.attr('data-remaining'));
    };
    set_remaining = function(remaining) {
      $current_opt.attr('data-remaining', remaining);
      return $('.remaining').text(remaining);
    };
    get_slot = function(label) {
      var opt, _i, _len, _ref;
      _ref = $('.slot option');
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        opt = _ref[_i];
        if ($(opt).text() === label) {
          return $(opt).attr('value');
        }
      }
    };
    set_slot = function() {
      slot_id = $(this).val();
      $current_opt = $(this).find("option[value=" + slot_id + "]");
      slot_label = $current_opt.text();
      return $('.remaining').text($current_opt.attr('data-remaining'));
    };
    set_slot.call($('.slot'));
    return $('.slot').change(set_slot);
  });

}).call(this);
